

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Usage &mdash; luksipc 0.04 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Conversion problems" href="problems.html" />
    <link rel="prev" title="Introduction" href="introduction.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> luksipc
          

          
          </a>

          
            
            
              <div class="version">
                0.05
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">luksipc Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#checklist">Checklist</a></li>
<li class="toctree-l2"><a class="reference internal" href="#preparation">Preparation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#plain-to-luks-conversion">Plain to LUKS conversion</a></li>
<li class="toctree-l2"><a class="reference internal" href="#luks-to-luks-conversion">LUKS to LUKS conversion</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="problems.html">Conversion problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">luksipc</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Usage</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/usage.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="usage">
<h1>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h1>
<p>The following section will now cover the basic usage of luksipc. There are two
distinct cases, one is the conversion of a unencrypted (plain) volume to LUKS
and the other is the conversion of an encrypted (LUKS) volume to another LUKS
volume. Both will need the same preparation steps before performing them.</p>
<div class="section" id="checklist">
<h2>Checklist<a class="headerlink" href="#checklist" title="Permalink to this headline">¶</a></h2>
<p>If you skip over everything else, <strong>please</strong> at least make sure you do these
steps before starting a conversion:</p>
<blockquote>
<div><ul class="simple">
<li><p>Resized file system size, shrunk size by at least 128 MiB</p></li>
<li><p>Unmounted file system</p></li>
<li><p>Laptop is connected to A/C power (if applicable)</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="preparation">
<span id="id1"></span><h2>Preparation<a class="headerlink" href="#preparation" title="Permalink to this headline">¶</a></h2>
<p>The first thing you need to do is resize your file system to accomodate for the
fact that the device is going to be a tiny bit smaller in the end (due to the
LUKS header). The LUKS header size is usually 16 MiB (it was 2 MiB in previous
versions or 1028 kiB for even older versions of cryptsetup), but you should
decrease the file system size by more (I suggest 128 MiB) to be on the safe
side.  If you decrease the size too much you have no drawbacks (and you can
easily increase after the conversion has been performed).</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Do not forget to shrink the file system before conversion</p>
</div>
<p>luksipc has no means of detecting wheter or not you have performed this step
and will not warn you if you haven’t (it has no knowledge of the underlying
file system). This might lead to very weird file system errors in the case that
your volume ever wants to use the whole space and it might even render your
volume completely unmountable (depending on the check the file system driver
performs on the block device before allowing mounting).</p>
<p>For example, let’s say you have a device at /dev/loop0 that has an ext4 file
system. You want to LUKSify it. We first resize our volume. For this we find
out how large the volume is currently:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># tune2fs -l /dev/loop0</span>
<span class="n">tune2fs</span> <span class="mf">1.42</span><span class="o">.</span><span class="mi">9</span> <span class="p">(</span><span class="mi">4</span><span class="o">-</span><span class="n">Feb</span><span class="o">-</span><span class="mi">2014</span><span class="p">)</span>
<span class="n">Filesystem</span> <span class="n">volume</span> <span class="n">name</span><span class="p">:</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>
<span class="n">Last</span> <span class="n">mounted</span> <span class="n">on</span><span class="p">:</span>          <span class="o">&lt;</span><span class="ow">not</span> <span class="n">available</span><span class="o">&gt;</span>
<span class="n">Filesystem</span> <span class="n">UUID</span><span class="p">:</span>          <span class="mi">713</span><span class="n">cc62e</span><span class="o">-</span><span class="n">b2a2</span><span class="o">-</span><span class="mi">406</span><span class="n">a</span><span class="o">-</span><span class="n">a82a</span><span class="o">-</span><span class="n">c4c1d01464e1</span>
<span class="n">Filesystem</span> <span class="n">magic</span> <span class="n">number</span><span class="p">:</span>  <span class="mh">0xEF53</span>
<span class="n">Filesystem</span> <span class="n">revision</span> <span class="c1">#:    1 (dynamic)</span>
<span class="n">Filesystem</span> <span class="n">features</span><span class="p">:</span>      <span class="n">has_journal</span> <span class="n">ext_attr</span> <span class="n">resize_inode</span> <span class="n">dir_index</span> <span class="n">filetype</span> <span class="n">extent</span> <span class="n">flex_bg</span> <span class="n">sparse_super</span> <span class="n">large_file</span> <span class="n">huge_file</span> <span class="n">uninit_bg</span> <span class="n">dir_nlink</span> <span class="n">extra_isize</span>
<span class="n">Filesystem</span> <span class="n">flags</span><span class="p">:</span>         <span class="n">signed_directory_hash</span>
<span class="n">Default</span> <span class="n">mount</span> <span class="n">options</span><span class="p">:</span>    <span class="n">user_xattr</span> <span class="n">acl</span>
<span class="n">Filesystem</span> <span class="n">state</span><span class="p">:</span>         <span class="n">clean</span>
<span class="n">Errors</span> <span class="n">behavior</span><span class="p">:</span>          <span class="n">Continue</span>
<span class="n">Filesystem</span> <span class="n">OS</span> <span class="nb">type</span><span class="p">:</span>       <span class="n">Linux</span>
<span class="n">Inode</span> <span class="n">count</span><span class="p">:</span>              <span class="mi">64000</span>
<span class="n">Block</span> <span class="n">count</span><span class="p">:</span>              <span class="mi">256000</span>
<span class="n">Reserved</span> <span class="n">block</span> <span class="n">count</span><span class="p">:</span>     <span class="mi">12800</span>
<span class="n">Free</span> <span class="n">blocks</span><span class="p">:</span>              <span class="mi">247562</span>
<span class="n">Free</span> <span class="n">inodes</span><span class="p">:</span>              <span class="mi">63989</span>
<span class="n">First</span> <span class="n">block</span><span class="p">:</span>              <span class="mi">0</span>
<span class="n">Block</span> <span class="n">size</span><span class="p">:</span>               <span class="mi">4096</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
<p>So we now know that our device is 256000 blocks of 4096 bytes each, so exactly
1000 MiB. We verify this is correct (it is in this case). So we now want to
decrease the file system size to 900 MiB. 900 MiB = 900 * 1024 * 1024 bytes =
943718400 bytes. With a file system block size of 4096 bytes we arrive at
943718400 / 4096 = 230400 blocks for the file system with decreased size. So we
resize the file system:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># resize2fs /dev/loop0 230400</span>
<span class="n">resize2fs</span> <span class="mf">1.42</span><span class="o">.</span><span class="mi">9</span> <span class="p">(</span><span class="mi">4</span><span class="o">-</span><span class="n">Feb</span><span class="o">-</span><span class="mi">2014</span><span class="p">)</span>
<span class="n">Resizing</span> <span class="n">the</span> <span class="n">filesystem</span> <span class="n">on</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">loop0</span> <span class="n">to</span> <span class="mi">230400</span> <span class="p">(</span><span class="mi">4</span><span class="n">k</span><span class="p">)</span> <span class="n">blocks</span><span class="o">.</span>
<span class="n">The</span> <span class="n">filesystem</span> <span class="n">on</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">loop0</span> <span class="ow">is</span> <span class="n">now</span> <span class="mi">230400</span> <span class="n">blocks</span> <span class="n">long</span><span class="o">.</span>
</pre></div>
</div>
<p>That was successful. Perfect. Now (if you haven’t already), umount the volume.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Do not forget to unmount the file system before conversion</p>
</div>
</div>
<div class="section" id="plain-to-luks-conversion">
<h2>Plain to LUKS conversion<a class="headerlink" href="#plain-to-luks-conversion" title="Permalink to this headline">¶</a></h2>
<p>After having done the preparation as described in the <a class="reference internal" href="#preparation"><span class="std std-ref">Preparation</span></a>
subsection, we can proceed to LUKSify the device. By default the initial
randomized key is read from /dev/urandom and written to
/root/initial_keyfile.bin. This is okay for us, we will remove the appropriate
keyslot for this random key anyways in the future.  It is only used for
bootstrapping. We start the conversion:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># ./luksipc -d /dev/loop0
WARNING! luksipc will perform the following actions:
   =&gt; Normal LUKSification of plain device /dev/loop0
   -&gt; luksFormat will be performed on /dev/loop0

Please confirm you have completed the checklist:
    [1] You have resized the contained filesystem(s) appropriately
    [2] You have unmounted any contained filesystem(s)
    [3] You will ensure secure storage of the keyfile that will be generated at /root/initial_keyfile.bin
    [4] Power conditions are satisfied (i.e. your laptop is not running off battery)
    [5] You have a backup of all important data on /dev/loop0

    /dev/loop0: 1024 MiB = 1.0 GiB
    Chunk size: 10485760 bytes = 10.0 MiB
    Keyfile: /root/initial_keyfile.bin
    LUKS format parameters: None given

Are all these conditions satisfied, then answer uppercase yes:
</pre></div>
</div>
<p>Please, read the whole message thourougly. There is no going back from this. If
and only if you’re 100% sure that all preconditions are satisfied, answer
“YES” and press return:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Are</span> <span class="nb">all</span> <span class="n">these</span> <span class="n">conditions</span> <span class="n">satisfied</span><span class="p">,</span> <span class="n">then</span> <span class="n">answer</span> <span class="n">uppercase</span> <span class="n">yes</span><span class="p">:</span> <span class="n">YES</span>
<span class="p">[</span><span class="n">I</span><span class="p">]:</span> <span class="n">Created</span> <span class="n">raw</span> <span class="n">device</span> <span class="n">alias</span><span class="p">:</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">loop0</span> <span class="o">-&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mapper</span><span class="o">/</span><span class="n">alias_luksipc_raw_89ee2dc8</span>
<span class="p">[</span><span class="n">I</span><span class="p">]:</span> <span class="n">Size</span> <span class="n">of</span> <span class="n">reading</span> <span class="n">device</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">loop0</span> <span class="ow">is</span> <span class="mi">1073741824</span> <span class="nb">bytes</span> <span class="p">(</span><span class="mi">1024</span> <span class="n">MiB</span> <span class="o">+</span> <span class="mi">0</span> <span class="nb">bytes</span><span class="p">)</span>
<span class="p">[</span><span class="n">I</span><span class="p">]:</span> <span class="n">Backing</span> <span class="n">up</span> <span class="n">physical</span> <span class="n">disk</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">loop0</span> <span class="n">header</span> <span class="n">to</span> <span class="n">backup</span> <span class="n">file</span> <span class="n">header_backup</span><span class="o">.</span><span class="n">img</span>
<span class="p">[</span><span class="n">I</span><span class="p">]:</span> <span class="n">Performing</span> <span class="n">luksFormat</span> <span class="n">of</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">loop0</span>
<span class="p">[</span><span class="n">I</span><span class="p">]:</span> <span class="n">Performing</span> <span class="n">luksOpen</span> <span class="n">of</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">loop0</span> <span class="p">(</span><span class="n">opening</span> <span class="k">as</span> <span class="n">mapper</span> <span class="n">name</span> <span class="n">luksipc_7a6bfc08</span><span class="p">)</span>
<span class="p">[</span><span class="n">I</span><span class="p">]:</span> <span class="n">Size</span> <span class="n">of</span> <span class="n">luksOpened</span> <span class="n">writing</span> <span class="n">device</span> <span class="ow">is</span> <span class="mi">1071644672</span> <span class="nb">bytes</span> <span class="p">(</span><span class="mi">1022</span> <span class="n">MiB</span> <span class="o">+</span> <span class="mi">0</span> <span class="nb">bytes</span><span class="p">)</span>
<span class="p">[</span><span class="n">I</span><span class="p">]:</span> <span class="n">Write</span> <span class="n">disk</span> <span class="n">smaller</span> <span class="n">than</span> <span class="n">read</span> <span class="n">disk</span> <span class="n">by</span> <span class="mi">2097152</span> <span class="nb">bytes</span> <span class="p">(</span><span class="mi">2048</span> <span class="n">kB</span> <span class="o">+</span> <span class="mi">0</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">occupied</span> <span class="n">by</span> <span class="n">LUKS</span> <span class="n">header</span><span class="p">)</span>
<span class="p">[</span><span class="n">I</span><span class="p">]:</span> <span class="n">Starting</span> <span class="n">copying</span> <span class="n">of</span> <span class="n">data</span><span class="p">,</span> <span class="n">read</span> <span class="n">offset</span> <span class="mi">10485760</span><span class="p">,</span> <span class="n">write</span> <span class="n">offset</span> <span class="mi">0</span>
<span class="p">[</span><span class="n">I</span><span class="p">]:</span>  <span class="mi">0</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span>  <span class="mf">10.8</span><span class="o">%</span>       <span class="mi">110</span> <span class="n">MiB</span> <span class="o">/</span> <span class="mi">1022</span> <span class="n">MiB</span>     <span class="mf">0.0</span> <span class="n">MiB</span><span class="o">/</span><span class="n">s</span>   <span class="n">Left</span><span class="p">:</span>     <span class="mi">912</span> <span class="n">MiB</span>  <span class="mi">0</span><span class="p">:</span><span class="mi">00</span> <span class="n">h</span><span class="p">:</span><span class="n">m</span>
<span class="p">[</span><span class="n">I</span><span class="p">]:</span>  <span class="mi">0</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span>  <span class="mf">20.5</span><span class="o">%</span>       <span class="mi">210</span> <span class="n">MiB</span> <span class="o">/</span> <span class="mi">1022</span> <span class="n">MiB</span>     <span class="mf">0.0</span> <span class="n">MiB</span><span class="o">/</span><span class="n">s</span>   <span class="n">Left</span><span class="p">:</span>     <span class="mi">812</span> <span class="n">MiB</span>  <span class="mi">0</span><span class="p">:</span><span class="mi">00</span> <span class="n">h</span><span class="p">:</span><span class="n">m</span>
<span class="p">[</span><span class="n">I</span><span class="p">]:</span>  <span class="mi">0</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span>  <span class="mf">30.3</span><span class="o">%</span>       <span class="mi">310</span> <span class="n">MiB</span> <span class="o">/</span> <span class="mi">1022</span> <span class="n">MiB</span>     <span class="mf">0.0</span> <span class="n">MiB</span><span class="o">/</span><span class="n">s</span>   <span class="n">Left</span><span class="p">:</span>     <span class="mi">712</span> <span class="n">MiB</span>  <span class="mi">0</span><span class="p">:</span><span class="mi">00</span> <span class="n">h</span><span class="p">:</span><span class="n">m</span>
<span class="p">[</span><span class="n">I</span><span class="p">]:</span>  <span class="mi">0</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span>  <span class="mf">40.1</span><span class="o">%</span>       <span class="mi">410</span> <span class="n">MiB</span> <span class="o">/</span> <span class="mi">1022</span> <span class="n">MiB</span>     <span class="mf">0.0</span> <span class="n">MiB</span><span class="o">/</span><span class="n">s</span>   <span class="n">Left</span><span class="p">:</span>     <span class="mi">612</span> <span class="n">MiB</span>  <span class="mi">0</span><span class="p">:</span><span class="mi">00</span> <span class="n">h</span><span class="p">:</span><span class="n">m</span>
<span class="p">[</span><span class="n">I</span><span class="p">]:</span>  <span class="mi">0</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span>  <span class="mf">49.9</span><span class="o">%</span>       <span class="mi">510</span> <span class="n">MiB</span> <span class="o">/</span> <span class="mi">1022</span> <span class="n">MiB</span>   <span class="mf">412.0</span> <span class="n">MiB</span><span class="o">/</span><span class="n">s</span>   <span class="n">Left</span><span class="p">:</span>     <span class="mi">512</span> <span class="n">MiB</span>  <span class="mi">0</span><span class="p">:</span><span class="mi">00</span> <span class="n">h</span><span class="p">:</span><span class="n">m</span>
<span class="p">[</span><span class="n">I</span><span class="p">]:</span>  <span class="mi">0</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span>  <span class="mf">59.7</span><span class="o">%</span>       <span class="mi">610</span> <span class="n">MiB</span> <span class="o">/</span> <span class="mi">1022</span> <span class="n">MiB</span>   <span class="mf">402.4</span> <span class="n">MiB</span><span class="o">/</span><span class="n">s</span>   <span class="n">Left</span><span class="p">:</span>     <span class="mi">412</span> <span class="n">MiB</span>  <span class="mi">0</span><span class="p">:</span><span class="mi">00</span> <span class="n">h</span><span class="p">:</span><span class="n">m</span>
<span class="p">[</span><span class="n">I</span><span class="p">]:</span>  <span class="mi">0</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span>  <span class="mf">69.5</span><span class="o">%</span>       <span class="mi">710</span> <span class="n">MiB</span> <span class="o">/</span> <span class="mi">1022</span> <span class="n">MiB</span>   <span class="mf">401.5</span> <span class="n">MiB</span><span class="o">/</span><span class="n">s</span>   <span class="n">Left</span><span class="p">:</span>     <span class="mi">312</span> <span class="n">MiB</span>  <span class="mi">0</span><span class="p">:</span><span class="mi">00</span> <span class="n">h</span><span class="p">:</span><span class="n">m</span>
<span class="p">[</span><span class="n">I</span><span class="p">]:</span>  <span class="mi">0</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span>  <span class="mf">79.3</span><span class="o">%</span>       <span class="mi">810</span> <span class="n">MiB</span> <span class="o">/</span> <span class="mi">1022</span> <span class="n">MiB</span>   <span class="mf">360.4</span> <span class="n">MiB</span><span class="o">/</span><span class="n">s</span>   <span class="n">Left</span><span class="p">:</span>     <span class="mi">212</span> <span class="n">MiB</span>  <span class="mi">0</span><span class="p">:</span><span class="mi">00</span> <span class="n">h</span><span class="p">:</span><span class="n">m</span>
<span class="p">[</span><span class="n">I</span><span class="p">]:</span>  <span class="mi">0</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span>  <span class="mf">89.0</span><span class="o">%</span>       <span class="mi">910</span> <span class="n">MiB</span> <span class="o">/</span> <span class="mi">1022</span> <span class="n">MiB</span>   <span class="mf">350.0</span> <span class="n">MiB</span><span class="o">/</span><span class="n">s</span>   <span class="n">Left</span><span class="p">:</span>     <span class="mi">112</span> <span class="n">MiB</span>  <span class="mi">0</span><span class="p">:</span><span class="mi">00</span> <span class="n">h</span><span class="p">:</span><span class="n">m</span>
<span class="p">[</span><span class="n">I</span><span class="p">]:</span>  <span class="mi">0</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span>  <span class="mf">98.8</span><span class="o">%</span>      <span class="mi">1010</span> <span class="n">MiB</span> <span class="o">/</span> <span class="mi">1022</span> <span class="n">MiB</span>   <span class="mf">344.8</span> <span class="n">MiB</span><span class="o">/</span><span class="n">s</span>   <span class="n">Left</span><span class="p">:</span>      <span class="mi">12</span> <span class="n">MiB</span>  <span class="mi">0</span><span class="p">:</span><span class="mi">00</span> <span class="n">h</span><span class="p">:</span><span class="n">m</span>
<span class="p">[</span><span class="n">I</span><span class="p">]:</span> <span class="n">Disk</span> <span class="n">copy</span> <span class="n">completed</span> <span class="n">successfully</span><span class="o">.</span>
<span class="p">[</span><span class="n">I</span><span class="p">]:</span> <span class="n">Synchronizing</span> <span class="n">disk</span><span class="o">...</span>
<span class="p">[</span><span class="n">I</span><span class="p">]:</span> <span class="n">Synchronizing</span> <span class="n">of</span> <span class="n">disk</span> <span class="n">finished</span><span class="o">.</span>
</pre></div>
</div>
<p>The volume was successfully converted! Now let’s first add a passphrase that we
want to use for the volume (or any other method of key, your choice). You can
actually even do this while the copying process is running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># cryptsetup luksAddKey /dev/loop0 --key-file=/root/initial_keyfile.bin</span>
<span class="n">Enter</span> <span class="n">new</span> <span class="n">passphrase</span> <span class="k">for</span> <span class="n">key</span> <span class="n">slot</span><span class="p">:</span>
<span class="n">Verify</span> <span class="n">passphrase</span><span class="p">:</span>
</pre></div>
</div>
<p>Let’s check this worked:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># cryptsetup luksDump /dev/loop0</span>
<span class="n">LUKS</span> <span class="n">header</span> <span class="n">information</span> <span class="k">for</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">loop0</span>

<span class="n">Version</span><span class="p">:</span>        <span class="mi">1</span>
<span class="n">Cipher</span> <span class="n">name</span><span class="p">:</span>    <span class="n">aes</span>
<span class="n">Cipher</span> <span class="n">mode</span><span class="p">:</span>    <span class="n">xts</span><span class="o">-</span><span class="n">plain64</span>
<span class="n">Hash</span> <span class="n">spec</span><span class="p">:</span>      <span class="n">sha1</span>
<span class="n">Payload</span> <span class="n">offset</span><span class="p">:</span> <span class="mi">4096</span>
<span class="n">MK</span> <span class="n">bits</span><span class="p">:</span>        <span class="mi">256</span>
<span class="n">MK</span> <span class="n">digest</span><span class="p">:</span>      <span class="n">b2</span> <span class="mi">34</span> <span class="n">b8</span> <span class="mi">7</span><span class="n">b</span> <span class="mi">70</span> <span class="n">e8</span> <span class="mi">78</span> <span class="mi">17</span> <span class="n">a4</span> <span class="mi">12</span> <span class="mi">00</span> <span class="mi">41</span> <span class="n">dc</span> <span class="n">a4</span> <span class="n">bc</span> <span class="mi">70</span> <span class="n">a3</span> <span class="mi">50</span> <span class="mi">02</span> <span class="mi">22</span>
<span class="n">MK</span> <span class="n">salt</span><span class="p">:</span>        <span class="n">ee</span> <span class="mi">25</span> <span class="n">b4</span> <span class="n">f0</span> <span class="mi">11</span> <span class="mi">94</span> <span class="mi">25</span> <span class="n">d1</span> <span class="mi">2</span><span class="n">b</span> <span class="mi">97</span> <span class="mi">42</span> <span class="mi">6</span><span class="n">c</span> <span class="n">a6</span> <span class="n">ff</span> <span class="mi">3</span><span class="n">d</span> <span class="mi">1</span><span class="n">d</span>
                <span class="n">e7</span> <span class="mi">6</span><span class="n">d</span> <span class="mi">1</span><span class="n">e</span> <span class="mi">15</span> <span class="n">dd</span> <span class="n">a0</span> <span class="mi">07</span> <span class="mi">17</span> <span class="mi">25</span> <span class="mi">82</span> <span class="n">d1</span> <span class="n">f9</span> <span class="mi">14</span> <span class="mi">6</span><span class="n">c</span> <span class="n">ab</span> <span class="n">e9</span>
<span class="n">MK</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">50125</span>
<span class="n">UUID</span><span class="p">:</span>           <span class="mf">3e21</span><span class="n">bbe0</span><span class="o">-</span><span class="mi">3</span><span class="n">d70</span><span class="o">-</span><span class="mi">4189</span><span class="o">-</span><span class="mi">8</span><span class="n">f19</span><span class="o">-</span><span class="mi">04</span><span class="n">fb7d7c5bb9</span>

<span class="n">Key</span> <span class="n">Slot</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ENABLED</span>
    <span class="n">Iterations</span><span class="p">:</span>             <span class="mi">201892</span>
    <span class="n">Salt</span><span class="p">:</span>                   <span class="mi">9</span><span class="n">d</span> <span class="n">b6</span> <span class="n">a1</span> <span class="n">f5</span> <span class="mi">0</span><span class="n">f</span> <span class="mi">91</span> <span class="n">ee</span> <span class="mi">24</span> <span class="n">be</span> <span class="mi">49</span> <span class="mi">0</span><span class="n">e</span> <span class="n">f7</span> <span class="n">f9</span> <span class="mi">62</span> <span class="n">a2</span> <span class="mi">06</span>
                            <span class="n">aa</span> <span class="mi">45</span> <span class="mi">79</span> <span class="mi">7</span><span class="n">f</span> <span class="mi">1</span><span class="n">a</span> <span class="mi">56</span> <span class="mi">5</span><span class="n">c</span> <span class="mi">8</span><span class="n">c</span> <span class="n">a3</span> <span class="mi">03</span> <span class="mi">15</span> <span class="n">a0</span> <span class="n">d2</span> <span class="mi">9</span><span class="n">e</span> <span class="n">ca</span> <span class="n">e5</span>
    <span class="n">Key</span> <span class="n">material</span> <span class="n">offset</span><span class="p">:</span>    <span class="mi">8</span>
    <span class="n">AF</span> <span class="n">stripes</span><span class="p">:</span>             <span class="mi">4000</span>
<span class="n">Key</span> <span class="n">Slot</span> <span class="mi">1</span><span class="p">:</span> <span class="n">ENABLED</span>
    <span class="n">Iterations</span><span class="p">:</span>             <span class="mi">198756</span>
    <span class="n">Salt</span><span class="p">:</span>                   <span class="mi">46</span> <span class="n">b4</span> <span class="mi">21</span> <span class="n">fb</span> <span class="n">e3</span> <span class="mi">12</span> <span class="mi">54</span> <span class="mi">18</span> <span class="n">ff</span> <span class="mi">8</span><span class="n">d</span> <span class="mi">05</span> <span class="mi">24</span> <span class="mi">75</span> <span class="n">fc</span> <span class="mi">3</span><span class="n">c</span> <span class="mi">4</span><span class="n">b</span>
                            <span class="mi">3</span><span class="n">c</span> <span class="mi">90</span> <span class="mi">77</span> <span class="mi">47</span> <span class="mi">43</span> <span class="n">b6</span> <span class="mi">0</span><span class="n">b</span> <span class="mi">28</span> <span class="n">d9</span> <span class="n">b6</span> <span class="mi">86</span> <span class="mi">44</span> <span class="mi">30</span> <span class="mi">9</span><span class="n">e</span> <span class="mi">20</span> <span class="n">d2</span>
    <span class="n">Key</span> <span class="n">material</span> <span class="n">offset</span><span class="p">:</span>    <span class="mi">264</span>
    <span class="n">AF</span> <span class="n">stripes</span><span class="p">:</span>             <span class="mi">4000</span>
<span class="n">Key</span> <span class="n">Slot</span> <span class="mi">2</span><span class="p">:</span> <span class="n">DISABLED</span>
<span class="n">Key</span> <span class="n">Slot</span> <span class="mi">3</span><span class="p">:</span> <span class="n">DISABLED</span>
<span class="n">Key</span> <span class="n">Slot</span> <span class="mi">4</span><span class="p">:</span> <span class="n">DISABLED</span>
<span class="n">Key</span> <span class="n">Slot</span> <span class="mi">5</span><span class="p">:</span> <span class="n">DISABLED</span>
<span class="n">Key</span> <span class="n">Slot</span> <span class="mi">6</span><span class="p">:</span> <span class="n">DISABLED</span>
<span class="n">Key</span> <span class="n">Slot</span> <span class="mi">7</span><span class="p">:</span> <span class="n">DISABLED</span>
</pre></div>
</div>
<p>You can see the initial keyfile (slot 0) and the passphrase we just added (slot
1). Let’s scrub the initial keyslot so the initial keyfile becomes useless. We
do this by scrubbing slot 0. Don’t worry, you cannot choose the wrong slot
here; cryptsetup won’t permit you to remove the wrong slot since you must prove
that you still have at least access to one remaining slot (by entering your
passphrase):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># cryptsetup luksKillSlot /dev/loop0 0</span>
<span class="n">Enter</span> <span class="nb">any</span> <span class="n">remaining</span> <span class="n">passphrase</span><span class="p">:</span>
</pre></div>
</div>
<p>And check again:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># cryptsetup luksDump /dev/loop0</span>
<span class="n">LUKS</span> <span class="n">header</span> <span class="n">information</span> <span class="k">for</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">loop0</span>

<span class="n">Version</span><span class="p">:</span>        <span class="mi">1</span>
<span class="n">Cipher</span> <span class="n">name</span><span class="p">:</span>    <span class="n">aes</span>
<span class="n">Cipher</span> <span class="n">mode</span><span class="p">:</span>    <span class="n">xts</span><span class="o">-</span><span class="n">plain64</span>
<span class="n">Hash</span> <span class="n">spec</span><span class="p">:</span>      <span class="n">sha1</span>
<span class="n">Payload</span> <span class="n">offset</span><span class="p">:</span> <span class="mi">4096</span>
<span class="n">MK</span> <span class="n">bits</span><span class="p">:</span>        <span class="mi">256</span>
<span class="n">MK</span> <span class="n">digest</span><span class="p">:</span>      <span class="n">b2</span> <span class="mi">34</span> <span class="n">b8</span> <span class="mi">7</span><span class="n">b</span> <span class="mi">70</span> <span class="n">e8</span> <span class="mi">78</span> <span class="mi">17</span> <span class="n">a4</span> <span class="mi">12</span> <span class="mi">00</span> <span class="mi">41</span> <span class="n">dc</span> <span class="n">a4</span> <span class="n">bc</span> <span class="mi">70</span> <span class="n">a3</span> <span class="mi">50</span> <span class="mi">02</span> <span class="mi">22</span>
<span class="n">MK</span> <span class="n">salt</span><span class="p">:</span>        <span class="n">ee</span> <span class="mi">25</span> <span class="n">b4</span> <span class="n">f0</span> <span class="mi">11</span> <span class="mi">94</span> <span class="mi">25</span> <span class="n">d1</span> <span class="mi">2</span><span class="n">b</span> <span class="mi">97</span> <span class="mi">42</span> <span class="mi">6</span><span class="n">c</span> <span class="n">a6</span> <span class="n">ff</span> <span class="mi">3</span><span class="n">d</span> <span class="mi">1</span><span class="n">d</span>
                <span class="n">e7</span> <span class="mi">6</span><span class="n">d</span> <span class="mi">1</span><span class="n">e</span> <span class="mi">15</span> <span class="n">dd</span> <span class="n">a0</span> <span class="mi">07</span> <span class="mi">17</span> <span class="mi">25</span> <span class="mi">82</span> <span class="n">d1</span> <span class="n">f9</span> <span class="mi">14</span> <span class="mi">6</span><span class="n">c</span> <span class="n">ab</span> <span class="n">e9</span>
<span class="n">MK</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">50125</span>
<span class="n">UUID</span><span class="p">:</span>           <span class="mf">3e21</span><span class="n">bbe0</span><span class="o">-</span><span class="mi">3</span><span class="n">d70</span><span class="o">-</span><span class="mi">4189</span><span class="o">-</span><span class="mi">8</span><span class="n">f19</span><span class="o">-</span><span class="mi">04</span><span class="n">fb7d7c5bb9</span>

<span class="n">Key</span> <span class="n">Slot</span> <span class="mi">0</span><span class="p">:</span> <span class="n">DISABLED</span>
<span class="n">Key</span> <span class="n">Slot</span> <span class="mi">1</span><span class="p">:</span> <span class="n">ENABLED</span>
    <span class="n">Iterations</span><span class="p">:</span>             <span class="mi">198756</span>
    <span class="n">Salt</span><span class="p">:</span>                   <span class="mi">46</span> <span class="n">b4</span> <span class="mi">21</span> <span class="n">fb</span> <span class="n">e3</span> <span class="mi">12</span> <span class="mi">54</span> <span class="mi">18</span> <span class="n">ff</span> <span class="mi">8</span><span class="n">d</span> <span class="mi">05</span> <span class="mi">24</span> <span class="mi">75</span> <span class="n">fc</span> <span class="mi">3</span><span class="n">c</span> <span class="mi">4</span><span class="n">b</span>
                            <span class="mi">3</span><span class="n">c</span> <span class="mi">90</span> <span class="mi">77</span> <span class="mi">47</span> <span class="mi">43</span> <span class="n">b6</span> <span class="mi">0</span><span class="n">b</span> <span class="mi">28</span> <span class="n">d9</span> <span class="n">b6</span> <span class="mi">86</span> <span class="mi">44</span> <span class="mi">30</span> <span class="mi">9</span><span class="n">e</span> <span class="mi">20</span> <span class="n">d2</span>
    <span class="n">Key</span> <span class="n">material</span> <span class="n">offset</span><span class="p">:</span>    <span class="mi">264</span>
    <span class="n">AF</span> <span class="n">stripes</span><span class="p">:</span>             <span class="mi">4000</span>
<span class="n">Key</span> <span class="n">Slot</span> <span class="mi">2</span><span class="p">:</span> <span class="n">DISABLED</span>
<span class="n">Key</span> <span class="n">Slot</span> <span class="mi">3</span><span class="p">:</span> <span class="n">DISABLED</span>
<span class="n">Key</span> <span class="n">Slot</span> <span class="mi">4</span><span class="p">:</span> <span class="n">DISABLED</span>
<span class="n">Key</span> <span class="n">Slot</span> <span class="mi">5</span><span class="p">:</span> <span class="n">DISABLED</span>
<span class="n">Key</span> <span class="n">Slot</span> <span class="mi">6</span><span class="p">:</span> <span class="n">DISABLED</span>
<span class="n">Key</span> <span class="n">Slot</span> <span class="mi">7</span><span class="p">:</span> <span class="n">DISABLED</span>
</pre></div>
</div>
<p>Perfect, only our slot 1 (passphrase) is left now, you can safely discard the
initial_keyfile.bin now.</p>
<p>Last step, resize the filesystem to its original size. For this we must first
mount the cryptographic file system and then call the resize2fs utility again:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># cryptsetup luksOpen /dev/loop0 newcryptofs</span>
<span class="n">Enter</span> <span class="n">passphrase</span> <span class="k">for</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">loop0</span><span class="p">:</span>

<span class="c1"># resize2fs /dev/mapper/newcryptofs</span>
<span class="n">resize2fs</span> <span class="mf">1.42</span><span class="o">.</span><span class="mi">9</span> <span class="p">(</span><span class="mi">4</span><span class="o">-</span><span class="n">Feb</span><span class="o">-</span><span class="mi">2014</span><span class="p">)</span>
<span class="n">Resizing</span> <span class="n">the</span> <span class="n">filesystem</span> <span class="n">on</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mapper</span><span class="o">/</span><span class="n">newcryptofs</span> <span class="n">to</span> <span class="mi">255488</span> <span class="p">(</span><span class="mi">4</span><span class="n">k</span><span class="p">)</span> <span class="n">blocks</span><span class="o">.</span>
<span class="n">The</span> <span class="n">filesystem</span> <span class="n">on</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mapper</span><span class="o">/</span><span class="n">newcryptofs</span> <span class="ow">is</span> <span class="n">now</span> <span class="mi">255488</span> <span class="n">blocks</span> <span class="n">long</span><span class="o">.</span>
</pre></div>
</div>
<p>You can see that the filesystem now occupies all available space (998 MiB).</p>
</div>
<div class="section" id="luks-to-luks-conversion">
<h2>LUKS to LUKS conversion<a class="headerlink" href="#luks-to-luks-conversion" title="Permalink to this headline">¶</a></h2>
<p>There are situations in which you might want to re-encrypt your LUKS device.
For example, let’s say you have a cryptographic volume and multiple users have
access to it, each with their own keyslot. Now suppose you forfeit the rights
of one person to the volume. Technically you would do this by killing the
appropriate key slot of the key that was assigned to the user. This means the
user can from then on not unlock the volume using the LUKS keyheader.</p>
<p>But suppose the user you want whose access you want to revoke had – while
still in possession of a valid key – access to the file system container
itself. Then with that LUKS header he can still (even when the slot was killed)
derive the underlying cryptographic key that secures the data. The only way to
remedy this is to reencrypt the whole volume with a different bulk-encryption
key.</p>
<p>Another usecase are old LUKS volumes: the algorithms that were used at creation
may not be suitable anymore. For example, maybe you have switched to some other
hardware platform that has hardware support for specific algorithms and you can
only take advantage of those when you choose a specific encryption algorithm.
Or maybe the alignment that was adequate a couple of years back is not adquate
anymore for you. For example, older cryptsetup instances used 1028 kiB headers,
which is an odd size. Or maybe LUKS gained new features that you want to use.</p>
<p>In any case, there are numerous cases why you want to turn a LUKS volume into
another LUKS volume. This process is called “reLUKSification” within luksipc
and it is something that is supported from 0.03 onwards.</p>
<p>Let’s say you have a partition called /dev/sdh2 which you want to reLUKSify.
First let’s see what the used encryption parameters are:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># cryptsetup luksDump /dev/sdh2</span>
<span class="n">LUKS</span> <span class="n">header</span> <span class="n">information</span> <span class="k">for</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdh2</span>

<span class="n">Version</span><span class="p">:</span>        <span class="mi">1</span>
<span class="n">Cipher</span> <span class="n">name</span><span class="p">:</span>    <span class="n">aes</span>
<span class="n">Cipher</span> <span class="n">mode</span><span class="p">:</span>    <span class="n">xts</span><span class="o">-</span><span class="n">plain64</span>
<span class="n">Hash</span> <span class="n">spec</span><span class="p">:</span>      <span class="n">sha1</span>
<span class="n">Payload</span> <span class="n">offset</span><span class="p">:</span> <span class="mi">4096</span>
<span class="n">MK</span> <span class="n">bits</span><span class="p">:</span>        <span class="mi">256</span>
<span class="n">MK</span> <span class="n">digest</span><span class="p">:</span>      <span class="n">b1</span> <span class="mi">44</span> <span class="mi">6</span><span class="n">a</span> <span class="mi">73</span> <span class="n">e3</span> <span class="mi">06</span> <span class="mi">27</span> <span class="mi">27</span> <span class="n">a2</span> <span class="n">fe</span> <span class="n">c2</span> <span class="mi">59</span> <span class="n">e5</span> <span class="mi">3</span><span class="n">a</span> <span class="mi">39</span> <span class="mi">2</span><span class="n">e</span> <span class="mi">15</span> <span class="n">d7</span> <span class="n">d7</span> <span class="n">e0</span>
<span class="n">MK</span> <span class="n">salt</span><span class="p">:</span>        <span class="mi">09</span> <span class="mi">6</span><span class="n">d</span> <span class="mi">6</span><span class="n">a</span> <span class="mi">24</span> <span class="mi">66</span> <span class="mi">28</span> <span class="mi">43</span> <span class="n">f7</span> <span class="n">f3</span> <span class="mi">55</span> <span class="n">a9</span> <span class="mi">9</span><span class="n">d</span> <span class="mi">0</span><span class="n">a</span> <span class="mi">40</span> <span class="mi">77</span> <span class="mi">58</span>
                <span class="n">e0</span> <span class="mi">1</span><span class="n">f</span> <span class="mi">7</span><span class="n">c</span> <span class="mi">30</span> <span class="n">b9</span> <span class="mi">63</span> <span class="mi">96</span> <span class="n">eb</span> <span class="mi">99</span> <span class="mi">34</span> <span class="mi">52</span> <span class="mi">4</span><span class="n">f</span> <span class="mi">72</span> <span class="n">ba</span> <span class="mi">57</span> <span class="n">ac</span>
<span class="n">MK</span> <span class="n">iterations</span><span class="p">:</span>  <span class="mi">49750</span>
<span class="n">UUID</span><span class="p">:</span>           <span class="mi">6495</span><span class="n">d24d</span><span class="o">-</span><span class="mi">34</span><span class="n">ac</span><span class="o">-</span><span class="mi">41</span><span class="n">f5</span><span class="o">-</span><span class="n">a594</span><span class="o">-</span><span class="n">c5058cc31ed3</span>

<span class="n">Key</span> <span class="n">Slot</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ENABLED</span>
    <span class="n">Iterations</span><span class="p">:</span>             <span class="mi">206119</span>
    <span class="n">Salt</span><span class="p">:</span>                   <span class="mi">99</span> <span class="n">c8</span> <span class="mi">48</span> <span class="mi">50</span> <span class="n">c3</span> <span class="n">a6</span> <span class="mi">83</span> <span class="mi">0</span><span class="n">d</span> <span class="n">f9</span> <span class="mi">39</span> <span class="n">a4</span> <span class="mi">4</span><span class="n">d</span> <span class="mi">0</span><span class="n">a</span> <span class="mi">35</span> <span class="n">b0</span> <span class="n">ab</span>
                            <span class="mi">13</span> <span class="mi">83</span> <span class="n">ee</span> <span class="n">fd</span> <span class="mi">9</span><span class="n">f</span> <span class="mi">91</span> <span class="mi">8</span><span class="n">d</span> <span class="mi">92</span> <span class="n">a6</span> <span class="n">cf</span> <span class="mi">42</span> <span class="mi">50</span> <span class="mi">9</span><span class="n">b</span> <span class="mi">89</span> <span class="n">a6</span> <span class="n">be</span>
    <span class="n">Key</span> <span class="n">material</span> <span class="n">offset</span><span class="p">:</span>    <span class="mi">8</span>
    <span class="n">AF</span> <span class="n">stripes</span><span class="p">:</span>             <span class="mi">4000</span>
<span class="n">Key</span> <span class="n">Slot</span> <span class="mi">1</span><span class="p">:</span> <span class="n">DISABLED</span>
<span class="n">Key</span> <span class="n">Slot</span> <span class="mi">2</span><span class="p">:</span> <span class="n">DISABLED</span>
<span class="n">Key</span> <span class="n">Slot</span> <span class="mi">3</span><span class="p">:</span> <span class="n">DISABLED</span>
<span class="n">Key</span> <span class="n">Slot</span> <span class="mi">4</span><span class="p">:</span> <span class="n">DISABLED</span>
<span class="n">Key</span> <span class="n">Slot</span> <span class="mi">5</span><span class="p">:</span> <span class="n">DISABLED</span>
<span class="n">Key</span> <span class="n">Slot</span> <span class="mi">6</span><span class="p">:</span> <span class="n">DISABLED</span>
<span class="n">Key</span> <span class="n">Slot</span> <span class="mi">7</span><span class="p">:</span> <span class="n">DISABLED</span>
</pre></div>
</div>
<p>We’ll now open the device with our old key (a passphrase):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># cryptsetup luksOpen /dev/sdh2 oldluks</span>
</pre></div>
</div>
<p>Just for demonstration purposes, we can calculate the MD5SUM over the whole
block device (you won’t need to do that, it’s just a demo):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># md5sum /dev/mapper/oldluks</span>
<span class="mi">48</span><span class="n">d9763be76ddb4fb990367f8d6b8c22</span>  <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mapper</span><span class="o">/</span><span class="n">oldluks</span>
</pre></div>
</div>
<p>For reLUKSification to work, you need to supply the path to the unlocked device
(from where data will be read) as well as the path to the underlying raw device
(which will be luksFormatted).</p>
<p>You currently have your (raw) disk at /dev/sdh2 and your (unlocked) read disk
at /dev/mapper/oldluks. It may be possible that a new LUKS header is even
larger than the old header as now, which will lead to truncation of data at the
very end of the partition. This will be the case, for example, if you reLUKSify
volumes that have a 1028 kiB LUKS header and recreate with a recent version
which writes 2048 kiB LUKS headers. You need to take all measures to decrease
the size of the contained file system, as shown in <a class="reference internal" href="#preparation"><span class="std std-ref">Preparation</span></a>.  These
steps will not be repeated here, but you <strong>must</strong> perform them nevertheless if
you want to avoid losing data.</p>
<p>After the disk is unlocked, you call luksipc. In addition to the raw device
which you want to convert you will also now have to specify the block device
name of the unlocked device. The raw device is the one that luksFormat and
luksOpen will be called on and the read device is the device from which data
will be read during the copy procedure. Here’s how the call to luksipc looks
like. We assume that we want to change the underlying hash function to SHA256:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># luksipc --device /dev/sdh2 --readdev /dev/mapper/oldluks --luksparams=&#39;-h,sha256&#39;
WARNING! luksipc will perform the following actions:
   =&gt; reLUKSification of LUKS device /dev/sdh2
   -&gt; Which has been unlocked at /dev/mapper/oldluks
   -&gt; luksFormat will be performed on /dev/sdh2

Please confirm you have completed the checklist:
    [1] You have resized the contained filesystem(s) appropriately
    [2] You have unmounted any contained filesystem(s)
    [3] You will ensure secure storage of the keyfile that will be generated at /root/initial_keyfile.bin
    [4] Power conditions are satisfied (i.e. your laptop is not running off battery)
    [5] You have a backup of all important data on /dev/sdh2

    /dev/sdh2: 2512 MiB = 2.5 GiB
    Chunk size: 10485760 bytes = 10.0 MiB
    Keyfile: /root/initial_keyfile.bin
    LUKS format parameters: -h,sha256

Are all these conditions satisfied, then answer uppercase yes: YES
[I]: Created raw device alias: /dev/sdh2 -&gt; /dev/mapper/alias_luksipc_raw_60377226
[I]: Size of reading device /dev/mapper/oldluks is 2631925760 bytes (2510 MiB + 0 bytes)
[I]: Backing up physical disk /dev/sdh2 header to backup file header_backup.img
[I]: Performing luksFormat of /dev/sdh2
[I]: Performing luksOpen of /dev/sdh2 (opening as mapper name luksipc_dbb86eda)
[I]: Size of luksOpened writing device is 2631925760 bytes (2510 MiB + 0 bytes)
[I]: Write disk size equal to read disk size.
[I]: Starting copying of data, read offset 10485760, write offset 0
[I]:  0:00:   4.4%       110 MiB / 2510 MiB    43.5 MiB/s   Left:    2400 MiB  0:00 h:m
[I]:  0:00:   8.4%       210 MiB / 2510 MiB    34.1 MiB/s   Left:    2300 MiB  0:01 h:m
[I]:  0:00:  12.4%       310 MiB / 2510 MiB    21.9 MiB/s   Left:    2200 MiB  0:01 h:m
[...]
[I]:  0:02:  88.0%      2210 MiB / 2510 MiB    17.3 MiB/s   Left:     300 MiB  0:00 h:m
[I]:  0:02:  92.0%      2310 MiB / 2510 MiB    17.6 MiB/s   Left:     200 MiB  0:00 h:m
[I]:  0:02:  96.0%      2410 MiB / 2510 MiB    18.0 MiB/s   Left:     100 MiB  0:00 h:m
[I]:  0:02: 100.0%      2510 MiB / 2510 MiB    18.2 MiB/s   Left:       0 MiB  0:00 h:m
[I]: Disk copy completed successfully.
[I]: Synchronizing disk...
[I]: Synchronizing of disk finished.
</pre></div>
</div>
<p>After the process has finished, the old LUKS device /dev/mapper/oldluks will
still be open. Be very careful not to do anything with that device, however!
It’s safe to close it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># cryptsetup luksClose oldluks</span>
</pre></div>
</div>
<p>Then, let’s open the device with the new key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># cryptsetup luksOpen /dev/sdh2 newluks -d /root/initial_keyfile.bin</span>
</pre></div>
</div>
<p>And check that the conversion worked:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># md5sum /dev/mapper/newluks</span>
<span class="mi">48</span><span class="n">d9763be76ddb4fb990367f8d6b8c22</span>  <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mapper</span><span class="o">/</span><span class="n">newluks</span>
</pre></div>
</div>
<p>Which it did :-)</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="problems.html" class="btn btn-neutral float-right" title="Conversion problems" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="introduction.html" class="btn btn-neutral float-left" title="Introduction" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2011-2019, Johannes Bauer

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>